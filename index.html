<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dumme KI ‚Äî Chat (sicher & Gemini-Proxy)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#ff6b6b;--muted:#94a3b8;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,var(--bg),#071024);color:#e6eef8}
    .app{max-width:1000px;margin:32px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 30px rgba(2,6,23,.6)}
    header{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);font-size:22px}
    h1{margin:0;font-size:20px}
    p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:12px;margin-top:18px;align-items:center;flex-wrap:wrap}
    .slider{display:flex;align-items:center;gap:8px}
    input[type=range]{accent-color:var(--accent)}

    .panel{margin-top:18px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}

    .chat{margin-top:18px;border-radius:10px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));min-height:300px;max-height:55vh;overflow:auto}
    .msg{display:flex;margin:10px 0;gap:12px}
    .bubble{max-width:78%;padding:10px 12px;border-radius:10px;background:var(--card);box-shadow:inset 0 -1px 0 rgba(255,255,255,0.02);font-size:14px}
    .user{justify-content:flex-end}
    .user .bubble{background:linear-gradient(90deg,#0b1220,#081424);border:1px solid rgba(255,255,255,0.02)}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}

    .composer{display:flex;gap:8px;margin-top:14px}
    textarea{flex:1;min-height:48px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;resize:vertical}
    button{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#ff8a6b);color:#06202a;font-weight:700;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}

    .footer{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px}
    .download{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}

    .small{font-size:13px;color:var(--muted)}

    @media (max-width:600px){.app{margin:12px;padding:14px}}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Sicherer Dumme KI Chat">
    <header>
      <div class="logo">DK</div>
      <div>
        <h1>Dumme KI ‚Äî Chat (sicher + Gemini)</h1>
        <p class="lead">Sichere Integration: Dummy-KI, Gemini via Backend-Proxy, Prompt-Validierung, Blacklist, Rate-Limit.</p>
      </div>
    </header>

    <div class="controls">
      <div class="slider">
        <label for="stupidRange" class="muted">Dummheitsgrad</label>
        <input id="stupidRange" type="range" min="1" max="10" value="7" aria-label="Dummheitsgrad">
      </div>
      <div class="muted">Antwort-Modus:</div>
      <select id="modeSelect" aria-label="Antwortmodus">
        <option value="random">Zuf√§llig</option>
        <option value="one-liner">One-Liner</option>
        <option value="rant">Langer Unsinn</option>
        <option value="poem">Kurzes Gedicht</option>
      </select>
      <button id="clearBtn" class="download">Chat leeren</button>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <label class="small">Engine:</label>
        <select id="engineSelect" aria-label="Engine">
          <option value="dumb">Eingebaute Dumme KI</option>
          <option value="gemini">Gemini (Proxy)</option>
        </select>
      </div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div class="composer">
      <textarea id="prompt" placeholder="Schreibe eine Frage..." aria-label="Eingabe"></textarea>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="sendBtn">Antwort</button>
        <button id="surpriseBtn" class="download">√úberrasche mich</button>
      </div>
    </div>

    <div class="footer">
      <div class="muted">Sicher & produktionsbereit: API-Key wird nie im Frontend gesendet. Rate-Limit: 15/h/IP. Fallback: Dummy-KI.</div>
      <div>
        <button id="downloadBtn" class="download">HTML herunterladen</button>
      </div>
    </div>
  </div>

  <script>
    const connectors = ["wie eine Kartoffel","auf einem Einrad","mit Marmelade","ohne Sinn und Verstand","unter Wasser","im Nebel","auf dem Mond","wie dein Onkel Hans"];
    const openings = ["Nat√ºrlich:","Absolut klar:","100% sicher:","Oh ja:","Definitiv:"];
    const sillyPhrases = ["Die Antwort ist blau.","Frag die Banane, sie wei√ü Bescheid.","Wenn du genau hinh√∂rst, h√∂rst du ein Sandwich.","Zuerst tanzt der K√ºhlschrank, dann die Welt.","Z√§hl bis unendlich ‚Äî dann bist du nah dran.","Nicht alle Eier sind Eier.","Kaffee ist die richtige L√∂sung, immer.","Sterne m√∂gen keine Socken."];

    const chatEl = document.getElementById('chat');
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');
    const surpriseBtn = document.getElementById('surpriseBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const stupidRange = document.getElementById('stupidRange');
    const modeSelect = document.getElementById('modeSelect');
    const engineSelect = document.getElementById('engineSelect');

    const obsceneBlacklist = ["arsch","schei√üe","fick","hurensohn","fotze"];
    const MAX_LENGTH = 1000;

    function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function userMessage(text){
      const wrap = document.createElement('div'); wrap.className='msg user';
      const b = document.createElement('div'); b.className='bubble'; b.textContent = text;
      wrap.appendChild(b);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function botMessage(html){
      const wrap = document.createElement('div'); wrap.className='msg';
      const b = document.createElement('div'); b.className='bubble'; b.innerHTML = html;
      wrap.appendChild(b);
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = 'KI ‚Ä¢ ' + new Date().toLocaleTimeString();
      wrap.appendChild(meta);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function checkPromptSecurity(prompt){
      if(!prompt || prompt.trim()==="") return false;
      if(prompt.length > MAX_LENGTH) return false;
      const lower = prompt.toLowerCase();
      for(const word of obsceneBlacklist){
        if(lower.includes(word)) return false;
      }
      return true;
    }

    async function sendGemini(prompt){
      try{
        const response = await fetch('/api/gemini',{ // Proxy Endpoint
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({prompt})
        });
        if(!response.ok){
          throw new Error('API-Fehler');
        }
        const data = await response.json();
        return data.answer || 'Keine Antwort erhalten.';
      } catch(e){
        console.error(e);
        return 'Fehler beim Abrufen von Gemini. Fallback: Dumme KI.';
      }
    }

    function generateDumbAnswer(prompt){
      const level = parseInt(stupidRange.value,10);
      const mode = modeSelect.value;
      if(!prompt || prompt.trim().length===0) prompt = '...';
      if(mode==='one-liner'){ return `${rand(openings)} ${rand(sillyPhrases)} ${rand(connectors)}`; }
      if(mode==='poem'){ return `Rosen sind rot, Katzen sind nett.<br>${prompt.slice(0,20)} ist wichtig, aber Kekse regeln das.<br>Ende.`; }
      if(mode==='rant'){ return `${rand(openings)} ${rand(sillyPhrases)} ‚Äî ${rand(connectors)} ‚Äî mehr Unsinn!`; }
      return `${rand(sillyPhrases)} ${rand(connectors)} ${rand(['üòÄ','ü§∑‚Äç‚ôÇÔ∏è','ü¶â','üçï'])}`;
    }

    async function send(){
      const text = promptEl.value;
      if(!checkPromptSecurity(text)){
        botMessage('<em>Prompt blockiert: Sicherheitsverletzung oder Blacklist.</em>');
        return;
      }
      userMessage(text);
      promptEl.value='';
      sendBtn.disabled = true;
      sendBtn.textContent='√úberlege...';
      let answer='';
      if(engineSelect.value==='gemini'){
        answer = await sendGemini(text);
        if(answer.includes('Fehler') || answer.includes('Fallback')){
          answer = generateDumbAnswer(text);
        }
      } else {
        answer = generateDumbAnswer(text);
      }
      botMessage(answer.replace(/\n/g,'<br>'));
      sendBtn.disabled=false;
      sendBtn.textContent='Antwort';
    }

    sendBtn.addEventListener('click',send);
    promptEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

    surpriseBtn.addEventListener('click',()=>{ promptEl.value = '√úberrasch mich mit Unsinn!'; send(); });
    clearBtn.addEventListener('click',()=>{ chatEl.innerHTML=''; promptEl.focus(); });

    downloadBtn.addEventListener('click',()=>{ const doc='<!doctype html>\n'+document.documentElement.outerHTML; const blob=new Blob([doc],{type:'text/html'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='dumme-ki-chat.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });

    botMessage('Hallo! Ich bin die <strong>Dumme KI</strong>. W√§hle Engine: Dumme KI oder Gemini (Proxy) ‚Äî Sicherheit aktiviert.');
  </script>
</body>
</html>
